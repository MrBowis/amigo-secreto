name: Pipeline CI/CD Seguro con IA

on:
  pull_request:
    branches: [ "test" ] # Se activa al hacer PR hacia test (desde dev)

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  # ======================================================
  # ETAPA 1: REVISI√ìN DE SEGURIDAD (IA)
  # ======================================================
  security-scan:
    runs-on: ubuntu-latest
    outputs:
      scan_result: ${{ steps.scan.outcome }}
    
    steps:
      - name: üì• Checkout del c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Necesario para ver todos los archivos

      - name: üì¢ Notificar Inicio Escaneo
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="üõ°Ô∏è Iniciando escaneo de seguridad (IA) en el PR #${{ github.event.pull_request.number }}..."

      - name: üêç Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: üì¶ Instalar Dependencias Python
        run: |
          pip install -r requirements.txt

      - name: üß† Ejecutar Modelo de IA (Scanner)
        id: scan
        continue-on-error: true # Continuamos para manejar el fallo manualmente
        run: |
          python security_scan.py

      # --- MANEJO DE VULNERABILIDAD (SI EL MODELO DETECTA ALGO) ---
      - name: ‚ùå Acciones si es Vulnerable
        if: steps.scan.outcome == 'failure'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            let report = "Vulnerabilidad detectada";
            try { report = fs.readFileSync('security_report.txt', 'utf8'); } catch(e){}
            
            // 1. Comentar en el PR
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: report
            });

            // 2. Etiquetar PR
            github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['fixing-required']
            });

            // 3. Crear Issue autom√°tica
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Vulnerabilidad Cr√≠tica detectada en Pipeline',
              body: 'El modelo de IA ha detectado c√≥digo inseguro en el PR #' + context.issue.number + '.\n\n' + report
            });

            // 4. Cerrar el PR (Rechazo autom√°tico seg√∫n PDF)
            github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              state: 'closed'
            });

      - name: üì¢ Notificar Vulnerabilidad (Telegram)
        if: steps.scan.outcome == 'failure'
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="‚õî ALERTA: C√≥digo Vulnerable detectado. PR rechazado y etiquetado."

      - name: üõë Detener Pipeline
        if: steps.scan.outcome == 'failure'
        run: exit 1

      - name: üì¢ Notificar √âxito Seguridad (Telegram)
        if: steps.scan.outcome == 'success'
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="‚úÖ C√≥digo clasificado como SEGURO. Continuando pipeline..."

  # ======================================================
  # ETAPA 2: MERGE A TEST Y PRUEBAS UNITARIAS
  # ======================================================
  merge-and-test:
    needs: security-scan
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      # Simulaci√≥n de Merge a Test (En Actions, el c√≥digo ya se prueba en el contexto del PR,
      # pero para cumplir el PDF estrictamente, hacemos un merge real si es necesario o probamos el merge resultante)
      - name: üîÄ Merge Autom√°tico a rama Test
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          
          # 1. Traemos la info de la rama destino (test)
          git fetch origin ${{ github.base_ref }}
          
          # 2. Traemos expl√≠citamente la info de la rama origen (dev)
          git fetch origin ${{ github.head_ref }}
          
          # 3. Nos cambiamos a test
          git checkout ${{ github.base_ref }}
          
          # 4. Mezclamos usando la referencia remota (origin/dev) que es m√°s segura
          git merge --no-ff origin/${{ github.head_ref }} -m "Auto-merge PR #${{ github.event.pull_request.number }} a test"
          
          # 5. Subimos cambios
          git push origin ${{ github.base_ref }}
      
      - name: üì¢ Notificar Merge Test
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="twisted_rightwards_arrows: Merge a rama TEST realizado con √©xito."

      - name: üü¢ Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: üì¶ Instalar Dependencias
        run: npm ci

      - name: üß™ Ejecutar Pruebas (Jest/Vitest)
        id: tests
        continue-on-error: true
        run: npm test # Aseg√∫rate de tener script "test" en package.json

      - name: ‚ùå Manejo de Fallo en Tests
        if: steps.tests.outcome == 'failure'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['tests-failed']
            });

      - name: üì¢ Notificar Fallo Tests (Telegram)
        if: steps.tests.outcome == 'failure'
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="‚ùå Las pruebas unitarias fallaron. Revisar etiquetas en GitHub."
          exit 1 # Romper pipeline

  # ======================================================
  # ETAPA 3: MERGE A MAIN Y DESPLIEGUE
  # ======================================================
  deploy-production:
    needs: merge-and-test
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          ref: test # Traemos lo que ya est√° en test probado

      - name: üîÄ Merge a Main
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          git fetch origin main
          git checkout main
          git merge --no-ff test -m "Deploy: Merge test a main"
          git push origin main

      # Construcci√≥n Docker como pide el PDF
      - name: üê≥ Build Docker Image
        run: |
          docker build -t mi-app-segura:latest .
          # Aqu√≠ ir√≠a el docker push si tuvieras DockerHub configurado
          # docker login -u ... -p ...
          # docker push mi-app-segura:latest

      # Simulaci√≥n de despliegue (puedes usar acci√≥n de Vercel/Render real aqu√≠)
      - name: üöÄ Despliegue en Producci√≥n (Simulado/Render/Vercel)
        run: |
          echo "Desplegando aplicaci√≥n en proveedor cloud..."
          # Ejemplo real si usaras Render:
          # curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK }}
          sleep 5 
          echo "Despliegue exitoso."

      - name: üì¢ Notificar √âxito Final (Telegram)
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="üöÄ DESPLIEGUE EXITOSO: El c√≥digo ha pasado todas las fases y est√° en producci√≥n."